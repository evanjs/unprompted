[template name="Bodysnatcher v2.1.0" id="bodysnatcher"]
[wizard tab _label="About"]
	[wizard markdown]
		Seamlessly replaces the selected subject of an image with a new one. This template works best with inpainting models and ControlNet.

		Always bodysnatch responsibly.
	[/wizard]
[/wizard]
[wizard tab _label="Documentation"]
	[wizard markdown _file="MANUAL.md"][/wizard]
[/wizard]
[wizard tab _label="Changelog"]
	[wizard markdown _file="CHANGELOG.md"][/wizard]
[/wizard]

[wizard accordion _label="‚öôÔ∏è Basic Settings" _open]
	[set class _new _label="Class" _info="The search term that determines the inpainting mask"][get global_class][/set]
	[set prefix _new _label="Prefix" _info="For example, the visual medium"][get global_prefix][/set]
	[set subject _new _label="New subject"][get global_subject][/set]
	[set simple_description _new _label="Simple Description" _info="These terms will apply to both the full image and the cropped face, 1-3 words are usually plenty"][/set]
	[set max_image_size _new _ui="number" _info="Limits both dimensions of the input image; 0 to disable. This will also ensure that both dimension are at least 512px."]1536[/set]
[/wizard]

[if max_image_size]
	[if "{image_info width} > max_image_size"][image_edit min_height=512 width="{get max_image_size}"][/if]
	[if "{image_info height} > max_image_size"][image_edit min_width=512 height="{get max_image_size}"][/if]
[/if]

[wizard accordion _label="üß© Presets"]
	[set inference_preset _new _info="Locks CFG scale, denoising strength, etc. to recommended values" _label="Inference Preset" _ui="dropdown" _choices="none|{filelist '%BASE_DIR%/templates/%PLACE%/presets/img2img/*.*' _basename _hide_ext _places='user|common'}"]general_v3[/set]
	[set body_controlnet_preset _new _info="Loads multiple ControlNet units, please make sure you have 'Allow other scripts to control this extension' enabled" _label="Body ControlNet Preset" _ui="dropdown" _choices="none|{filelist '%BASE_DIR%/templates/%PLACE%/presets/controlnet/*.*' _basename _hide_ext _places='user|common'}"]xl_quickshot_v1[/set]
	[set face_controlnet_preset _new _info="(Experimental; not recommended!) Loads a ControlNet unit for the face upscale step" _label="Face ControlNet Preset" _ui="dropdown" _choices="none|{filelist '%BASE_DIR%/templates/%PLACE%/presets/controlnet/*.*' _basename _hide_ext _places='user|common'}"]none[/set]
[/wizard]

[wizard accordion _label="üé≠ Mask Settings"]
	[wizard row]
		[set keep_hands _new _label="ü§ö Keep original hands" _ui="checkbox"]1[/set]
		[set keep_feet _new _label="ü¶∂ Keep original feet" _ui="checkbox"]0[/set]
	[/wizard]
	[set mask_method _new _label="Masking method" _ui="radio" _choices="panoptic_sam|clipseg|none"]panoptic_sam[/set]
	[wizard row]
		[set mask_sort_method _new _label="Sort method" _ui="dropdown" _choices="random|left-to-right|top-to-bottom|big-to-small|in-to-out"]left-to-right[/set]
		[set mask_index _new _label="Index" _ui=number _minimum=0]0[/set]
		[set reverse_mask_sort _new _label="Reverse" _ui="checkbox"]0[/set]
	[/wizard]
	[set manual_mask_mode _new _label="Manual masking mode" _ui="radio" _choices="add|subtract|discard"]subtract[/set]
	[wizard row]
		[set mask_informs_size _new _ui="checkbox" _label="Mask informs size" _info="The aspect ratio of the mask will dictate the image dimensions for inpainting. (Masked only mode)"]1[/set]
		[set mask_size_limit _new _ui="number" _info="Pixel cap"]1024[/set]
	[/wizard]
	[set interrogate _new _ui="checkbox" _label="Interrogate masked subject" _info="Adds a descriptive caption to the prompt; recommended when the new subject is of the same class as the original subject."]1[/set]
	[set blacklist_tags _new _info="Tags that will be removed from the interrogation result, separated by the standard delimiter (vertical pipe by default). You can also use shortcodes here. Only compatible with WaifuDiffusion captioners."][/set]
	[set mask_precision _new _label="Mask precision"]75[/set]
	[set mask_padding _new _label="Mask padding in pixels"]10[/set]
	[set stamp _new _label="Stamp" _info="Paste a temporary image on the init image for the purpose of masking (check unprompted/images/stamps for default stamps)"][/set]
	[set background_mode _new _label="Background Mode" _ui="checkbox" _info="Inverts the class mask and disables the zoom_enhance step (note: you'll probably want to increase the mask_precision - try 150 precision to start)"]0[/set]
[/wizard]

[wizard accordion _label="üé® Color Correction Settings"]
	[set color_correct_method _new _label="Color correct method" _ui="dropdown" _choices="none|hm|mvgd|mkl|hm-mvgd-hm|hm-mkl-hm"]mkl[/set]
	[set color_correct_timing _new _label="Color correct timing" _info="Post may produce more accurate colors, but it tends to look a bit posterized" _ui="dropdown" _choices="pre|post"]pre[/set]
	[set color_correct_strength _new _label="Color correct opacity" _ui="slider" _minimum=0 _maximum=1 _step=0.01 _info="Blends with the original image"]0.5[/set]
[/wizard]

[wizard accordion _label="üîç Zoom Enhance Settings"]
	[set do_zoom_enhance _new _label="Apply zoom_enhance" _ui="checkbox" _info="Note: Using Facelift is generally a better option for faces!"]0[/set]
	[set fix_bodypart _new _label="Fix a body part" _info="Note: currently not compatible with Background Mode"]face[/set]
	[set zoom_enhance_denoising_max _new _label="Max denoising strength"]0.45[/set]
	[set zoom_enhance_base_cfg _new _ui="slider" _minimum=1 _maximum="30" _label="Minimum CFG for upscaling step"]10[/set]
	[set zoom_enhance_inherit_negative _new _ui="checkbox" _label="Inherit the negative prompt during upscaling step"]1[/set]
	[set show_original _new _label="Show unenhanced image in output window" _ui="checkbox"]0[/set]
[/wizard]

[set debug _new _label="Debug Mode" _ui="checkbox"]0[/set]

[sets neg_mask=""]
[if "(keep_hands==1 and background_mode==0) or (keep_hands==0 and background_mode==1)"]
	[sets neg_mask=fingers]
[/if]
[if "(keep_feet==1 and background_mode==0) or (keep_feet==0 and background_mode==1)"]
	[if neg_mask][set neg_mask _append]|[/set][/if]
	[set neg_mask _append]feet[/set]
[/if]

[if "inference_preset != 'none'"]
	[call "/presets/img2img/{get inference_preset}" _places="user|common"]
	
[/if]

[if "body_controlnet_preset != 'none'"]
	[call "/presets/controlnet/{get body_controlnet_preset}" _places="user|common"]
[/if]

[if batch_index=0]
	[if "mask_method != 'none'"]
		[set bodysnatch_mask][txt2mask precision="{get mask_precision}" method="{get mask_method}" mode="{get manual_mask_mode}" negative_mask="{get neg_mask}" neg_padding="{get mask_padding}" padding="{get mask_padding}" aspect_var="mask_aspect_ratio" mask_sort_method="{get mask_sort_method}" reverse_mask_sort="{get reverse_mask_sort}" mask_index="{get mask_index}" blur=2 return_image show][get class][/txt2mask][/set]
		[if "inpaint_full_res == 0"]
			[img2img_autosize]
		[/if]
		[elif mask_informs_size]
			[if "mask_aspect_ratio < 1"]
				[log]Portrait aspect ratio detected[/log]
				[sets float_height="{get sd_res} / {get mask_aspect_ratio}"]
				[sets float_height="{get float_height} / 8"]
				[sets height="{cast int}{min '{{round float_height _down}} * 8' mask_size_limit}{/cast}"]
				[sets width="{get sd_res}"]
			[/if]
			[else]
				[log]Landscape aspect ratio detected[/log]
				[sets float_width="{get sd_res} * {get mask_aspect_ratio}"]
				[sets float_width="{get float_width} / 8"]
				[sets width="{cast int}{min '{{round float_width _down}} * 8' mask_size_limit}{/cast}"]
				[sets height="{get sd_res}"]
			[/else]
		[/elif]
	[/if]
	[else]
		[img2img_autosize]
		[set bodysnatch_mask][get image_mask][/set]
		[if manual_mask_mode="subtract"]
			[sets inpainting_mask_invert=1]
		[/if]
		[if "keep_hands==1 or keep_feet==1"]
			[txt2mask precision="{get mask_precision}" mode="add" padding=5 mask_blur=20][get neg_mask][/txt2mask]
		[/if]
	[/else]
	[if background_mode=1]
		[invert_mask]
	[/if]
[/if]
[if "background_mode==0 and batch_index==0 and do_zoom_enhance==1"]
	[after]
		[zoom_enhance _alt mask_method="{get mask_method}" color_correct_method="{get color_correct_method}" color_correct_timing="{get color_correct_timing}" color_correct_strength="{get color_correct_strength}" sharpen_amount=0.0 mode="discard" mask="{get class} {get fix_bodypart}" replacement="{get prefix} {get subject} {get fix_bodypart} {get simple_description _before=' '}" cfg_scale_min="{get zoom_enhance_base_cfg}" denoising_max="{get zoom_enhance_denoising_max}" controlnet_preset="{get face_controlnet_preset}" debug="{get debug}" inherit_negative="{get zoom_enhance_inherit_negative}" show_original="{get show_original}" no_sync]
	[/after]
[/if]
[set relevant_image][image_edit mask="{get bodysnatch_mask}" return copy][/set]
[get prefix] [get subject][get simple_description _before=" "], [get global_fluff][if interrogate]%SPACE%BREAK 
[replace _from="_" _to=" "][interrogate bypass_cache method="WaifuDiffusion" model="SmilingWolf/wd-vit-tagger-v3" image="{get relevant_image}" blacklist_tags="{get blacklist_tags}"][/replace][/if]
[if "color_correct_method != 'none'"]
	[after]
		[set new_image][image_edit mask="{get bodysnatch_mask}" return copy][/set]
		[set new_image][image_edit input="{get new_image}" color_match="{get relevant_image}" color_match_method="{get color_correct_method}" color_match_strength="{get color_correct_strength}" return][/set]
		[image_edit paste="{get new_image}"]
	[/after]
[/if]