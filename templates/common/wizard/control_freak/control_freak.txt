[template name="Control Freak v0.0.1" id="control_freak"]
[wizard tab _label="About"]
	[wizard markdown]
		Parses the prompt prompt and automatically loads the best matching ControlNet image from your collection.

		**Initial setup required!** Please review the Documentation tab for more information.
	[/wizard]
[/wizard]
[wizard tab _label="Documentation"]
	[wizard markdown _file="MANUAL.md"][/wizard]
[/wizard]
[wizard tab _label="Changelog"]
	[wizard markdown _file="CHANGELOG.md"][/wizard]
[/wizard]

[set control_subject _new _label="Subject"]Terms to parse with Control Freak[/set]
[set control_subject_original][get control_subject][/set]

[wizard row]
	[set control_whitelist _new _label="Whitelist Terms" _info="The ControlNet image must have these terms."][/set]
	[set control_blacklist _new _label="Blacklist Terms" _info="The ControlNet image must not have these terms."][/set]
[/wizard]

[if "batch_real_index > 0"]
	[log ERROR]Control Freak bypassed for batch index > 1.[/log]
	[break]
[/if]

[set cn_freak_event]pre[/set]

[set control_method _new _ui="dropdown" _choices="smart|path|random"]smart[/set]

[set control_effects _new _multiselect _ui="dropdown" _choices="{filelist '%BASE_DIR%/templates/%PLACE%/presets/control_freak/effects/**/*.txt' _basename _hide_ext _recursive _places='user|common'}"]may_flip_horizontal[/set]

[wizard accordion _label="⚙️ Advanced Settings"]
	[set control_cn_preset _new _info="Please make sure you have 'Allow other scripts to control this extension' enabled" _label="ControlNet Preset" _ui="dropdown" _choices="none|{filelist '%BASE_DIR%/templates/%PLACE%/presets/controlnet/*.*' _basename _hide_ext _places='user|common'}"]xl_promax_v1[/set]
	[set control_ar _label="Aspect Ratio Handling" _new _ui="dropdown" _choices="inform_autopilot|prefer_mine|prefer_cn|exclude_mismatched"]inform_autopilot[/set]
	[set control_winner_threshold _new _info="If a ControlNet image has at least this many matching tags, it might be chosen even if some other images have more." _ui="number"]5[/set]
	[set control_winner_margin _new _info="If a ControlNet image is within this many matching tags of the most accurate image, it might be chosen as the winner." _ui="number"]0[/set]
	[set control_caption_method _new _ui="dropdown" _choices="none|add_difference|add_all" _info="Choose what to do with the captions of the selected image."]add_difference[/set]
	[set control_do_negative _new _info="Allows Control Freak to adjust the negative prompt style." _ui="checkbox" _label="Negative Style"]1[/set]
	[set control_do_extra _new _info="Allows Control Freak to load extra networks such as LORAs." _ui="checkbox" _label="Extra Style"]1[/set]
[/wizard]

[image_edit unload_cache]

[# Populate master list]
[set control_images][filelist "%BASE_DIR%/templates/user/presets/control_freak/images/**/*.png" _recursive][/set]
[set best_score]0[/set]
[log]What is control_images? [get control_images][/log]

[# TODO: Load delimiter character dynamically]
[function get_image_tags image_filename="C:/some/path.png"]
	[set this_image_path][info path][get image_filename][/info][/set]
	[set cn_freak_event_bak][get cn_freak_event][/set]
	[set cn_freak_event]tags[/set]
	[set extra_tags][call "{get this_image_path}/function" _suppress_errors][/set]
	[set cn_freak_event][get cn_freak_event_bak][/set]

	[set control_tags][replace _from="," _to="|" _delimiter="%bypass%"][replace _from=", " _to=","][get extra_tags], [info filename][get image_filename][/info][/replace][/replace][/set]
[/function]

[switch control_method]
	[case "smart"]
		[for i=0 "i < {length control_images}" "i+1"]
			[call get_image_tags image_filename="{array control_images i}"]
			[set control_score]0[/set]

			[# Call user functions if it exists]
			[set this_image_path][info path][array control_images i][/info][/set]
			[call "{get this_image_path}/function" _suppress_errors]
			
			[for j=0 "j < {length control_tags}" "j+1"]
				[set this_string][array control_tags j][/set]
				[set first_char][substring start=0 end=1][get this_string][/substring][/set]
				[if "first_char == '_'"][continue][/if]

				[set blacklist_score][info string_count="this_string"][get control_blacklist][/info][/set]
				[if "blacklist_score > 0"]
					[set control_score]0[/set]
					[break]
				[/if]

				[if "{exists control_whitelist}"]
					[set whitelist_score][info string_count="this_string"][get control_whitelist][/info][/set]
					[if "whitelist_score == 0"]
						[set control_score]0[/set]
						[break]
					[/if]
				[/if]
				
				[set control_score _append][info string_count="this_string"][get control_subject][/info][/set]
			[/for]
			[if "control_score > best_score"]
				[set best_score][get control_score][/set]
			[/if]
			[array control_scores _append="{get control_score}"]
		[/for]

		[log]Best score is [get best_score].[/log]
		[set my_ar][eval][get width] / [get height][/eval][/set]
		[if "best_score > 0"]
			[for i=0 "i < {length control_scores}" "i+1"]
				[if "{array control_scores i} >= (best_score - control_winner_margin) or {array control_scores i} >= control_winner_threshold and {array control_scores i} > 0"]
					[if "control_ar == 'exclude_mismatched'"]
						[set this_cn_ar][eval][image_info file="{array control_images i}" delimiter="/" width height][/eval][/set]
						[if "{abs}{eval}my_ar - this_cn_ar{/eval}{/abs} > 0.45"]
							[log]Excluding this image from selection due to aspect ratio mismatch.[/log]
						[/if]
						[else]
							[log]The index [get i] is one of the winners.[/log]
							[array winners _append="{array control_images i}"]
						[/else]
					[/if]
					[else]
						[log]The index [get i] is one of the winners.[/log]
						[array winners _append="{array control_images i}"]
					[/else]
				[/if]
			[/for]
			[log]The winner(s): [get winners][/log]
			[set winner][choose][get winners][/choose][/set]
		[/if]
	[/case]
	[case "path"]
		[set winner][get control_subject][/set]
		[set control_subject] [/set]
	[/case]
	[case "random"]
		[set winner_idx][random "{length control_images}-1"][/set]
		[set winner][array control_images "winner_idx"][/set]
	[/case]
[/switch]

[if "control_method != 'smart'"]
	[set best_score]1[/set]
	[set winners]1[/set]
[/if]

[if "best_score > 0 and winners"]
	[if "control_caption_method == 'add_difference' or control_caption_method == 'add_all'"]
		[call get_image_tags image_filename="{get winner}"]
		[set control_filtered_caption] [/set]
		[for i=0 "i < {length control_tags}" "i+1"]
			[set this_string][array control_tags i][/set]
			[set first_char][substring start=0 end=1][get this_string][/substring][/set]
			[if "first_char == '_'"][continue][/if]
			[set this_score][info string_count="this_string"][get control_subject_original][/info][/set]
			[if "this_score == 0 or control_caption_method == 'add_all'"]
				[set control_filtered_caption _append], [get this_string][/set]
			[/if]
		[/for]
		[set control_subject][get control_subject][get control_filtered_caption][/set]
	[/if]
	[else]
		[unset control_subject]
	[/else]

	[if "control_ar == 'prefer_cn'"]
		[img2img_autosize input="{get winner}"]
	[/if]
	[elif "control_ar == 'inform_autopilot'"]
		[set detect_preset][eval][image_info file="{get winner}" delimiter="/" width height][/eval][/set]
	[/elif]

	[for i=0 "i < {length control_effects}" "i+1"]
		[call "/presets/control_freak/effects/{array control_effects i}" _places="user|common" ]
	[/for]
	
	[set cn_0_image][get winner][/set]

	[if "control_cn_preset != 'none'"]
		[call "/presets/controlnet/{get control_cn_preset}" _places="user|common"]
	[/if]

	[# Assumes that Control Freak images have already been preprocessed.]
	[unset cn_0_module]

	[# Print the combined Control Freak prompt]
	[get control_subject]

	[if "control_do_negative"]
		[set negative_prompt _append][get control_negative][/set]
	[/if]
[/if]
[elif "control_method == 'smart'"]
	[get control_subject]
[/elif]